    <link rel="stylesheet" type="text/css" href="__STATIC__/home/css/pages-cart.css" />

	<script type="text/javascript" src="__STATIC__/home/js/pages/index.js"></script>

	<!--主内容-->
	<div class="cart py-container">
		<!--All goods-->
		<div class="allgoods">
			<h4>全部商品<span>11</span></h4>
			<div class="cart-main">
				<div class="yui3-g cart-th">
					<div class="yui3-u-1-4"><input type="checkbox" name="" id="" value="" /> 全部</div>
					<div class="yui3-u-1-4">商品</div>
					<div class="yui3-u-1-8">单价（元）</div>
					<div class="yui3-u-1-8">数量</div>
					<div class="yui3-u-1-8">小计（元）</div>
					<div class="yui3-u-1-8">操作</div>
				</div>
				<div class="cart-item-list">
					<div class="cart-shop">
						<input type="checkbox" name="" id="" value="" />
						<span class="shopname self">传智自营</span>
					</div>
					<div class="cart-body">
						{foreach $list as $v}
						<div class="cart-list">
							<ul class="goods-list yui3-g" goods_id="{$v.goods_id}" goods_attr_ids="{$v.goods_attr_ids}" cart_id="{$v.id}" number="{$v.number}">
								<li class="yui3-u-1-24">
									<input type="checkbox" class="row_check" name="" id="" value="" />
								</li>
								<li class="yui3-u-6-24">
									<div class="good-item">
										<div class="item-img"><img src="{$v.goods.goods_logo}" /></div>
										<div class="item-msg">{$v.goods.goods_name}</div>
									</div>
								</li>
								<li class="yui3-u-5-24">
									<div class="item-txt">
									{foreach $v['goodsattr'] as $attr}
									{$attr.attr_name}:{$attr.attr_value}
									{/foreach}
									</div>
								</li>
								<li class="yui3-u-1-8"><span class="price">{$v.goods.goods_price}</span></li>
								<li class="yui3-u-1-8">
									<a href="javascript:void(0)" class="increment mins">-</a>
									<input autocomplete="off" type="text" value="{$v.number}" minnum="1" class="itxt current_number" />
									<a href="javascript:void(0)" class="increment plus">+</a>
								</li>
								<li class="yui3-u-1-8"><span class="sum">{$v.goods.goods_price * $v.number}</span></li>
								<li class="yui3-u-1-8">
									<a href="#none" class="delete">删除</a><br />
									<a href="#none">移到我的关注</a>
								</li>
							</ul>
						</div>
						{/foreach}
					</div>
				</div>
			</div>
			<div class="cart-tool">
				<div class="select-all">
					<input type="checkbox" class="check_all" name="check_all" value="" />
					<span>全选</span>
				</div>
				<div class="option">
					<a href="#none">删除选中的商品</a>
					<a href="#none">移到我的关注</a>
					<a href="#none">清除下柜商品</a>
				</div>
				<div class="money-box">
					<div class="chosed">已选择<span id="total_number">0</span>件商品</div>
					<div class="sumprice">
						<span><em>总价（不含运费） ：</em><i id="total_price" class="summoney">¥0</i></span>
						<span><em>已节省：</em><i>-¥0</i></span>
					</div>
					<div class="sumbtn">
						<a class="sum-btn" href="javascript:;">结算</a>
					</div>
				</div>
			</div>
			<div class="clearfix"></div>
			<div class="deled">
				<span>已删除商品，您可以重新购买或加关注：</span>
				<div class="cart-list del">
					<ul class="goods-list yui3-g">
						<li class="yui3-u-1-2">
							<div class="good-item">
								<div class="item-msg">Apple Macbook Air 13.3英寸笔记本电脑 银色（Corei5）处理器/8GB内存</div>
							</div>
						</li>
						<li class="yui3-u-1-6"><span class="price">8848.00</span></li>
						<li class="yui3-u-1-6">
							<span class="number">1</span>
						</li>
						<li class="yui3-u-1-8">
							<a href="#none">重新购买</a>
							<a href="#none">移到我的关注</a>
						</li>
					</ul>
				</div>
			</div>
			<div class="liked">
				<ul class="sui-nav nav-tabs">
					<li class="active">
						<a href="#index" data-toggle="tab">猜你喜欢</a>
					</li>
					<li>
						<a href="#profile" data-toggle="tab">特惠换购</a>
					</li>
				</ul>
				<div class="clearfix"></div>
				<div class="tab-content">
					<div id="index" class="tab-pane active">
						<div id="myCarousel" data-ride="carousel" data-interval="4000" class="sui-carousel slide">
							<div class="carousel-inner">
								<div class="active item">
									<ul>
										<li>
											<img src="__STATIC__/home/img/like1.png" />
											<div class="intro">
												<i>Apple苹果iPhone 6s (A1699)</i>
											</div>
											<div class="money">
												<span>$29.00</span>
											</div>
											<div class="incar">
												<a href="#" class="sui-btn btn-bordered btn-xlarge btn-default"><i class="car"></i><span class="cartxt">加入购物车</span></a>
											</div>
										</li>
										<li>
											<img src="__STATIC__/home/img/like2.png" />
											<div class="intro">
												<i>Apple苹果iPhone 6s (A1699)</i>
											</div>
											<div class="money">
												<span>$29.00</span>
											</div>
											<div class="incar">
												<a href="#" class="sui-btn btn-bordered btn-xlarge btn-default"><i class="car"></i><span class="cartxt">加入购物车</span></a>
											</div>
										</li>
										<li>
											<img src="__STATIC__/home/img/like3.png" />
											<div class="intro">
												<i>Apple苹果iPhone 6s (A1699)</i>
											</div>
											<div class="money">
												<span>$29.00</span>
											</div>
											<div class="incar">
												<a href="#" class="sui-btn btn-bordered btn-xlarge btn-default"><i class="car"></i><span class="cartxt">加入购物车</span></a>
											</div>
										</li>
										<li>
											<img src="__STATIC__/home/img/like4.png" />
											<div class="intro">
												<i>Apple苹果iPhone 6s (A1699)</i>
											</div>
											<div class="money">
												<span>$29.00</span>
											</div>
											<div class="incar">
												<a href="#" class="sui-btn btn-bordered btn-xlarge btn-default"><i class="car"></i><span class="cartxt">加入购物车</span></a>
											</div>
										</li>
									</ul>
								</div>
								<div class="item">
									<ul>
										<li>
											<img src="__STATIC__/home/img/like1.png" />
											<div class="intro">
												<i>Apple苹果iPhone 6s (A1699)</i>
											</div>
											<div class="money">
												<span>$29.00</span>
											</div>
											<div class="incar">
												<a href="#" class="sui-btn btn-bordered btn-xlarge btn-default"><i class="car"></i><span class="cartxt">加入购物车</span></a>
											</div>
										</li>
										<li>
											<img src="__STATIC__/home/img/like2.png" />
											<div class="intro">
												<i>Apple苹果iPhone 6s (A1699)</i>
											</div>
											<div class="money">
												<span>$29.00</span>
											</div>
											<div class="incar">
												<a href="#" class="sui-btn btn-bordered btn-xlarge btn-default"><i class="car"></i><span class="cartxt">加入购物车</span></a>
											</div>
										</li>
										<li>
											<img src="__STATIC__/home/img/like3.png" />
											<div class="intro">
												<i>Apple苹果iPhone 6s (A1699)</i>
											</div>
											<div class="money">
												<span>$29.00</span>
											</div>
											<div class="incar">
												<a href="#" class="sui-btn btn-bordered btn-xlarge btn-default"><i class="car"></i><span class="cartxt">加入购物车</span></a>
											</div>
										</li>
										<li>
											<img src="__STATIC__/home/img/like4.png" />
											<div class="intro">
												<i>Apple苹果iPhone 6s (A1699)</i>
											</div>
											<div class="money">
												<span>$29.00</span>
											</div>
											<div class="incar">
												<a href="#" class="sui-btn btn-bordered btn-xlarge btn-default"><i class="car"></i><span class="cartxt">加入购物车</span></a>
											</div>
										</li>
									</ul>
								</div>
							</div>
							<a href="#myCarousel" data-slide="prev" class="carousel-control left">‹</a>
							<a href="#myCarousel" data-slide="next" class="carousel-control right">›</a>
						</div>
					</div>
					<div id="profile" class="tab-pane">
						<p>特惠选购</p>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
//		window.onload = function () {
//            //封装计算已选商品数量和金额
//            var changeTotal = function () {
//                var row_check = document.querySelectorAll('.row_check:checked');
//                var total_number = 0;
//                var total_price = 0;
//                for(var i=0;i<row_check.length;i++){
//                    var li = row_check[i].parentNode;
//                    var ul = li.parentNode;
//                    var current_number = parseInt(ul.querySelector('.current_number').value);
//                    total_number += current_number;
//                    var sum = parseFloat(ul.querySelector('.sum').innerHTML);
//                    total_price += sum;
//                }
//                document.getElementById('total_number').innerHTML = total_number;
//                document.getElementById('total_price').innerHTML = "￥" + total_price;
//            }
//			var plus = document.getElementsByClassName(' plus');
//			for (var i=0;i<plus.length;i++){
//				plus[i].onclick = function () {
//					var number = parseInt(this.previousElementSibling.value);
//                    number++;
//                    this.previousElementSibling.value = number;
//                    var price = parseInt(this.parentNode.parentNode.querySelector('.price').innerHTML);
//                    var sum = price * number;
//                    this.parentNode.parentNode.querySelector('.sum').innerHTML = sum;
//                    changeTotal();
//				}
//			}
//
//			var mins = document.getElementsByClassName(' mins');
//			for (var i=0;i<mins.length;i++){
//				mins[i].onclick = function () {
//                    var number = parseInt(this.nextElementSibling.value);
//					if (number>0){
//                        number--;
//                        this.nextElementSibling.value = number;
//                        var price = parseInt(this.parentNode.parentNode.querySelector('.price').innerHTML);
//                        var sum = price * number;
//                        this.parentNode.parentNode.querySelector('.sum').innerHTML = sum;
//                        changeTotal();
//					}
//				}
//			}
//
//			var check_all = document.querySelector('.check_all');
//			check_all.onchange = function () {
//				var status = this.checked;
//				var row_check = document.querySelectorAll('.row_check');
//				for (var i=0;i<row_check.length;i++){
//					row_check[i].checked = status;
//                    changeTotal();
//				}
//			}
//
//			var row_check = document.querySelectorAll('.row_check');
//			for (var i=0;i<row_check.length;i++){
//				row_check[i].onchange = function () {
//					console.log(123);
//					var all_number = row_check.length;
//					var checked_number = document.querySelectorAll('.row_check:checked').length;
//					var status = all_number == checked_number;
//					document.querySelector('.check_all').checked = status;
//                    changeTotal();
//				}
//			}
//		}
	</script>
	<script type="text/javascript">
		$(function () {
			//封装一个重新计算商品数量和金额的函数
			var changenum = function (number,element) {
				//组装请求参数
				var data = {
					"goods_id":$(element).closest('ul').attr('goods_id'),
					"goods_attr_ids":$(element).closest('ul').attr('goods_attr_ids'),
					"number":number,
				};
//				console.log(data);
				//发送请求
				$.ajax({
					"url":"{:url('changenum')}",
					"type":"post",
					"data":data,
					"dataType":"json",
					"success":function (res) {
						if(res.code != 10000){
							alert(res.msg);return;
						}else{
							//修改成功
							//将新的数量显示到页面 当前行的input中
							$(element).closest('ul').find('.current_number').val(number);
							//计算当前行的小计金额
							//取当前行的单价
							var price = parseFloat($(element).closest('ul').find('.price').html());
							//重新计算小计金额
							var sum = price * number;
							//将新的小计金额显示到当前行
							$(element).closest('ul').find('.sum').html(sum);
							//将当前行ul上记录的旧的购买数量进行修改
							$(element).closest('ul').attr('number',number);
							//调用changetotal函数重新计算商品数量和价格
							changetotal();
						}
					}
				})
			}
			var changetotal = function () {
				var checked = $('.row_check:checked');
				var total_number = 0;
				var total_price = 0;
				$.each(checked,function (i,v) {
					total_number += parseInt( $(v).closest('ul').find('.current_number').val() );
					total_price += parseFloat( $(v).closest('ul').find('.sum').html() );
				});
				$('#total_number').html(total_number);
				$('#total_price').html('￥'+total_price);
			}
			$('.plus').click(function () {
				var current_number = parseInt( $(this).prev().val() );
				var new_number = current_number + 1;
//				$(this).prev().val(current_number);
//				var price = parseFloat( $(this).closest('.cart-list').find('.price').html() );
//				var sum = current_number * price;
//				$(this).closest('.cart-list').find('.sum').html(sum);
//				changetotal();
				//调用changenum函数发送ajax请求
				changenum(new_number,this);
			});
			$('.mins').click(function () {
				var current_number = parseInt( $(this).next().val() );
				if(current_number == 0)return;
				var new_number = current_number - 1;
//				$(this).next().val(current_number);
//				var price = parseFloat( $(this).closest('.cart-list').find('.price').html() );
//				var sum = current_number * price;
//				$(this).closest('.cart-list').find('.sum').html(sum);
//				changetotal();
				//调用changenum函数发送ajax请求
				changenum(new_number,this);
			});
			//全选
			$('.check_all').change(function () {
				var status = $('.check_all').prop('checked');
				//console.log(status);
				$('.row_check').prop('checked',status);
				changetotal();
			});
			$('.row_check').change(function () {
				var all = $('.row_check');
				//console.log(all);
				var checked = $('.row_check:checked');
				//console.log(checked);
				var status = all.length == checked.length;
				//console.log(status);
				$('.check_all').prop('checked',status);
				changetotal();
			});
			$('.current_number').change(function () {
				//获取到input中的值
				var new_number = parseInt($(this).val());
				//将修改之前的数据取出来 用于报错提示后 恢复
				var old_number = $(this).closest('ul').attr('number');
				//判断数据格式
				if(isNaN(new_number)){
					alert('购买数量必须是数字');
					$(this).val(old_number);
					return;
				}
				if(new_number < 1){
					alert('购买数量至少一件');
					$(this).val(old_number);
					return;
				}
				//调用changenum函数发送ajax请求
				changenum(new_number,this);
			})
			//删除绑定点击事件
			$('.delete').click(function () {
				//组装请求参数
				var data = {
					'goods_id':$(this).closest('ul').attr('goods_id'),
					'goods_attr_ids':$(this).closest('ul').attr('goods_attr_ids'),
				};
				var _this = this;
				//发送ajax
				$.ajax({
					'url':'{:url("delcart")}',
					'type':'post',
					'data':data,
					'dataType':'json',
					'success':function (res) {
						if(res.code != 10000){
							alert(res.msg);
							return;
						}
						//删除成功 当前行记录 从页面移除
						$(_this).closest('ul').parent().remove();
						//调用changetotal函数重新计算已选商品数量和金额
						changetotal();
					}
				});
			});
			//结算绑定点击事件
			$('.sum-btn').click(function () {
				//获取选中的行 对应的主键id值 拼接cart_ids参数
				var checked_checkbox = $('.row_check:checked');
				//判断 没有选中记录 则无法跳转
				if(checked_checkbox.length == 0){
					return;
				}
				var cart_ids = '';
				$.each(checked_checkbox,function (i,v) {
					cart_ids += $(v).closest('ul').attr('cart_id') + ',';
				});
				//去除最后一个逗号
				cart_ids = cart_ids.slice(0,-1);
				console.log(cart_ids);
				//页面跳转
				location.href = '{:url("home/order/create")}' + '?cart_ids=' + cart_ids;
			})
		})
	</script>